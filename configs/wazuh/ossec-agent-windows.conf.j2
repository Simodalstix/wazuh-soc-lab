<!--
  Wazuh Agent Configuration Template for Windows Systems
  Generated by Ansible for {{ inventory_hostname }}
  Agent Name: {{ wazuh_agent_name }}
  Agent Groups: {{ wazuh_agent_groups | join(', ') }}
-->

<ossec_config>
  <client>
    <server>
      <address>{{ wazuh_manager_ip }}</address>
      <port>{{ wazuh_manager_port }}</port>
      <protocol>tcp</protocol>
    </server>
    <config-profile>{{ wazuh_agent.config_profile }}</config-profile>
    <notify_time>10</notify_time>
    <time-reconnect>60</time-reconnect>
    <auto_restart>yes</auto_restart>
    <crypto_method>aes</crypto_method>
  </client>

  <client_buffer>
    <disabled>no</disabled>
    <queue_size>{{ windows_performance.queue_size | default(16384) }}</queue_size>
    <events_per_second>{{ windows_performance.max_events_per_second | default(1000) }}</events_per_second>
  </client_buffer>

  <!-- Windows Event Log Monitoring -->
  <localfile>
    <location>Security</location>
    <log_format>eventlog</log_format>
  </localfile>

  <localfile>
    <location>System</location>
    <log_format>eventlog</log_format>
  </localfile>

  <localfile>
    <location>Application</location>
    <log_format>eventlog</log_format>
  </localfile>

  <!-- PowerShell Monitoring -->
  <localfile>
    <location>Microsoft-Windows-PowerShell/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- Sysmon Monitoring (if installed) -->
  <localfile>
    <location>Microsoft-Windows-Sysmon/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- Windows Defender -->
  <localfile>
    <location>Microsoft-Windows-Windows Defender/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

{% if 'domain_controller' in wazuh_agent_groups %}
  <!-- Active Directory Monitoring -->
  <localfile>
    <location>Directory Service</location>
    <log_format>eventlog</log_format>
  </localfile>

  <localfile>
    <location>DNS Server</location>
    <log_format>eventlog</log_format>
  </localfile>

  <localfile>
    <location>Microsoft-Windows-ActiveDirectory_DomainService/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <localfile>
    <location>Microsoft-Windows-ADFS/Admin</location>
    <log_format>eventchannel</log_format>
  </localfile>
{% endif %}

  <!-- IIS Monitoring (if web server role) -->
{% if 'web' in wazuh_agent_groups %}
  <localfile>
    <location>C:\inetpub\logs\LogFiles\W3SVC1\*.log</location>
    <log_format>iis</log_format>
  </localfile>
{% endif %}

  <!-- File Integrity Monitoring -->
  <syscheck>
    <disabled>no</disabled>
    <frequency>43200</frequency>
    <scan_on_start>yes</scan_on_start>
    <auto_ignore frequency="10" timeframe="3600">no</auto_ignore>
    <alert_new_files>yes</alert_new_files>
    <remove_old_diff>yes</remove_old_diff>
    <restart_audit>yes</restart_audit>

    <!-- System directories -->
    <directories realtime="yes">C:\Windows\System32</directories>
    <directories>C:\Windows\SysWOW64</directories>
    <directories>C:\Program Files</directories>
    <directories>C:\Program Files (x86)</directories>
    
    <!-- User directories -->
    <directories realtime="yes">C:\Users\Administrator\Desktop</directories>
    <directories>C:\Users\Administrator\Documents</directories>
    
    <!-- System configuration -->
    <directories>C:\Windows\System32\drivers\etc</directories>
    <directories>C:\Windows\System32\config</directories>

{% if 'web' in wazuh_agent_groups %}
    <!-- Web directories -->
    <directories realtime="yes">C:\inetpub\wwwroot</directories>
{% endif %}

    <!-- Registry monitoring -->
    <windows_registry>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</windows_registry>
    <windows_registry>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</windows_registry>
    <windows_registry>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx</windows_registry>
    <windows_registry>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services</windows_registry>
    <windows_registry>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon</windows_registry>
    <windows_registry>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Active Setup\Installed Components</windows_registry>

    <!-- Ignore files -->
    <ignore>C:\Windows\System32\LogFiles</ignore>
    <ignore>C:\Windows\System32\wbem\Logs</ignore>
    <ignore>C:\Windows\Logs</ignore>
    <ignore>C:\Windows\Temp</ignore>
    <ignore>C:\Windows\SoftwareDistribution</ignore>
    <ignore>C:\Windows\System32\config\systemprofile\AppData</ignore>

    <!-- Check the file, but never compute the diff -->
    <nodiff>C:\Windows\System32\config\SAM</nodiff>
    <nodiff>C:\Windows\System32\config\SECURITY</nodiff>
    <nodiff>C:\Windows\System32\config\SYSTEM</nodiff>
  </syscheck>

  <!-- Rootcheck -->
  <rootcheck>
    <disabled>no</disabled>
    <windows_apps>./shared/win_applications_rcl.txt</windows_apps>
    <windows_malware>./shared/win_malware_rcl.txt</windows_malware>
    <frequency>43200</frequency>
  </rootcheck>

  <!-- Security Configuration Assessment -->
  <sca>
    <enabled>yes</enabled>
    <scan_on_start>yes</scan_on_start>
    <interval>12h</interval>
    <skip_nfs>yes</skip_nfs>
  </sca>

  <!-- System inventory -->
  <wodle name="syscollector">
    <disabled>no</disabled>
    <interval>1h</interval>
    <scan_on_start>yes</scan_on_start>
    <hardware>yes</hardware>
    <os>yes</os>
    <network>yes</network>
    <packages>yes</packages>
    <ports all="no">yes</ports>
    <processes>yes</processes>
    <hotfixes>yes</hotfixes>
  </wodle>

  <!-- Active response -->
  <active-response>
    <disabled>no</disabled>
    <ca_store>wpk_root.pem</ca_store>
    <ca_verification>yes</ca_verification>
  </active-response>

  <!-- Log all events -->
  <logging>
    <log_format>plain</log_format>
  </logging>

</ossec_config>