# IPTables rules for Wazuh SOC Lab Manager
# Generated by Ansible
#
# These rules provide a secure baseline for the Wazuh Manager server.
# They are designed to be applied using `iptables-restore < iptables.rules`.

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# Allow loopback traffic
-A INPUT -i lo -j ACCEPT

# Allow established and related connections
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# Allow SSH from management network
-A INPUT -p tcp -s 192.168.1.0/24 --dport 22 -m conntrack --ctstate NEW -j ACCEPT

# Allow Wazuh agent communication
-A INPUT -p tcp --dport 1514 -m conntrack --ctstate NEW -j ACCEPT

# Allow Wazuh agent registration
-A INPUT -p tcp --dport 1515 -m conntrack --ctstate NEW -j ACCEPT

# Allow Wazuh API access from management network
-A INPUT -p tcp -s 192.168.1.0/24 --dport 55000 -m conntrack --ctstate NEW -j ACCEPT

# Allow Wazuh Dashboard (HTTPS) from management and DMZ networks
-A INPUT -p tcp -s 192.168.1.0/24 --dport 443 -m conntrack --ctstate NEW -j ACCEPT
-A INPUT -p tcp -s 192.168.2.0/24 --dport 443 -m conntrack --ctstate NEW -j ACCEPT

# Allow Elasticsearch API from management network
-A INPUT -p tcp -s 192.168.1.0/24 --dport 9200 -m conntrack --ctstate NEW -j ACCEPT

# Allow syslog from pfSense and other network devices
-A INPUT -p udp -s 192.168.1.0/24 --dport 514 -m conntrack --ctstate NEW -j ACCEPT

# Allow ICMP (ping) from management network
-A INPUT -p icmp -s 192.168.1.0/24 --icmp-type 8 -j ACCEPT

# Log and drop all other incoming traffic
-A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables-denied: " --log-level 7
-A INPUT -j DROP

COMMIT

*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# Example NAT rule (if needed)
# -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 8080

COMMIT

*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

COMMIT

*raw
:PREROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

COMMIT