#!/bin/bash
#
# MySQL Database Backup Script
# This script performs a backup of all MySQL databases.

# Backup directory
BACKUP_DIR="/opt/db-backups"

# Date format for backup files
DATE=$(date +%Y-%m-%d_%H-%M-%S)

# MySQL credentials
MYSQL_USER="root"
MYSQL_PASSWORD="{{ mysql_password }}"

# Backup filename
BACKUP_FILE="$BACKUP_DIR/mysql-backup-$DATE.sql.gz"

# Create backup directory if it doesn't exist
mkdir -p $BACKUP_DIR

# Perform the backup
mysqldump -u $MYSQL_USER -p$MYSQL_PASSWORD --all-databases | gzip > $BACKUP_FILE

# Check if the backup was successful
if [ ${PIPESTATUS[0]} -eq 0 ]; then
  echo "MySQL backup successful: $BACKUP_FILE"
else
  echo "MySQL backup failed."
  exit 1
fi

# Remove backups older than 7 days
find $BACKUP_DIR -type f -name "*.sql.gz" -mtime +7 -delete