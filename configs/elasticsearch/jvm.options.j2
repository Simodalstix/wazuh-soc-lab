# JVM Options for Elasticsearch - Wazuh SOC Lab
# Optimized for 6GB RAM system
# Generated by Ansible

################################################################
## IMPORTANT: JVM heap size
################################################################
##
## The heap size is automatically configured by Elasticsearch
## based on the available memory in your system and the roles
## each node is configured to fulfill. If specifying heap is
## required, it should be done through a file in jvm.options.d,
## which should be named with .options suffix, and the heap size
## should be set to the same value in -Xms and -Xmx.
##
## See https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html
## for more information
##
################################################################

# Xms represents the initial size of total heap space
# Xmx represents the maximum size of total heap space
# Optimized for 6GB RAM system - allocating 2GB to Elasticsearch
-Xms2g
-Xmx2g

################################################################
## Expert settings
################################################################
##
## All settings below this section are considered
## expert settings. Don't tamper with them unless
## you understand what you are doing
##
################################################################

## GC configuration
8-13:-XX:+UseConcMarkSweepGC
8-13:-XX:CMSInitiatingOccupancyFraction=75
8-13:-XX:+UseCMSInitiatingOccupancyOnly

## G1GC Configuration
# NOTE: G1 GC is only supported on JDK version 10 or later
# to use G1GC, uncomment the next two lines and comment the CMS settings above.
14-:-XX:+UseG1GC
14-:-XX:G1HeapRegionSize=32m

## JVM temporary directory
-Djava.io.tmpdir=${ES_TMPDIR}

## heap dumps

# generate a heap dump when an allocation from the Java heap fails
# heap dumps are created in the working directory of the JVM
-XX:+HeapDumpOnOutOfMemoryError

# specify an alternative path for heap dumps; ensure the directory exists and
# has sufficient space
-XX:HeapDumpPath=data

# specify an alternative path for JVM fatal error logs
-XX:ErrorFile=logs/hs_err_pid%p.log

## JDK 8 GC logging
8:-XX:+PrintGCDetails
8:-XX:+PrintGCTimeStamps
8:-XX:+PrintGCDateStamps
8:-XX:+PrintClassHistogram
8:-XX:+PrintTenuringDistribution
8:-XX:+PrintGCApplicationStoppedTime
8:-Xloggc:logs/gc.log
8:-XX:+UseGCLogFileRotation
8:-XX:NumberOfGCLogFiles=32
8:-XX:GCLogFileSize=64m

# JDK 9+ GC logging
9-:-Xlog:gc*,gc+age=trace,safepoint:logs/gc.log:utctime,pid,tags:filecount=32,filesize=64m

# JDK 11 server class machine optimizations
11-:-XX:+UnlockExperimentalVMOptions
11-:-XX:+UseJVMCICompiler

## Locale
# Set the locale language
#-Duser.language=en

# Set the locale country
#-Duser.country=US

# Set the locale variant, if any
#-Duser.variant=

## basic

# disable calls to System#gc
-XX:+DisableExplicitGC

# pre-touch memory pages used by the JVM during initialization
-XX:+AlwaysPreTouch

## flags to configure Netty
-Dio.netty.noUnsafe=true
-Dio.netty.noKeySetOptimization=true
-Dio.netty.recycler.maxCapacityPerThread=0
-Dio.netty.allocator.numDirectArenas=0

## log4j 2
-Dlog4j.shutdownHookEnabled=false
-Dlog4j2.disable.jmx=true

-Djava.locale.providers=SPI,COMPAT

## heap size check
-XX:MaxDirectMemorySize=1073741824

## file encoding
-Dfile.encoding=UTF-8

## listeners
-Djdk.nio.maxCachedBufferSize=262144

## assertions
-ea:org.elasticsearch...
-da:org.elasticsearch.xpack.ccr...

## hsperfdata
-XX:+PerfDisableSharedMem

## blackhole
-XX:+UnlockDiagnosticVMOptions
-XX:+DebugNonSafepoints

# JDK 8 compiler optimizations
8:-XX:+UseStringDeduplication

# JDK 9+ optimizations
9-:-XX:+UnlockExperimentalVMOptions
9-:-XX:+UseTransparentHugePages

# Performance optimizations for lab environment
-XX:+UseCompressedOops
-XX:+UseCompressedClassPointers
-XX:+OptimizeStringConcat
-XX:+UseStringDeduplication

# Memory optimizations for 6GB constraint
-XX:NewRatio=3
-XX:SurvivorRatio=8
-XX:MaxTenuringThreshold=15

# GC tuning for lab workload
-XX:+UseParNewGC
-XX:+UseConcMarkSweepGC
-XX:CMSInitiatingOccupancyFraction=70
-XX:+UseCMSInitiatingOccupancyOnly
-XX:+CMSParallelRemarkEnabled
-XX:+CMSClassUnloadingEnabled
-XX:+UseCMSCompactAtFullCollection
-XX:CMSFullGCsBeforeCompaction=0

# JIT compiler optimizations
-XX:+TieredCompilation
-XX:TieredStopAtLevel=4
-XX:+UseCodeCacheFlushing
-XX:ReservedCodeCacheSize=256m
-XX:InitialCodeCacheSize=64m

# Class loading optimizations
-XX:+UseSharedSpaces
-XX:+UseAppCDS

# Network optimizations
-Djava.net.preferIPv4Stack=true
-Dnetworkaddress.cache.ttl=60
-Dnetworkaddress.cache.negative.ttl=10

# Security optimizations
-Djava.security.egd=file:/dev/./urandom

# Debugging options (disabled for production)
# -XX:+PrintGCDetails
# -XX:+PrintGCTimeStamps
# -XX:+PrintGCApplicationStoppedTime
# -XX:+PrintPromotionFailure
# -XX:PrintFLSStatistics=1

# JFR (Java Flight Recorder) settings for monitoring
-XX:+FlightRecorder
-XX:StartFlightRecording=duration=60s,filename=logs/elasticsearch-startup.jfr

# Large pages support (if available)
-XX:+UseLargePages

# NUMA optimizations (if applicable)
-XX:+UseNUMA

# Compressed OOPs optimizations
-XX:+UseCompressedOops
-XX:+UseCompressedClassPointers

# String optimizations
-XX:+OptimizeStringConcat
-XX:+UseStringDeduplication

# Method inlining optimizations
-XX:MaxInlineLevel=15
-XX:FreqInlineSize=325

# Loop optimizations
-XX:+UseLoopPredicate
-XX:+RangeCheckElimination
-XX:+EliminateLocks
-XX:+DoEscapeAnalysis

# Biased locking (can be disabled for better performance in some cases)
-XX:+UseBiasedLocking

# Fast thread local allocation
-XX:+UseTLAB
-XX:+ResizeTLAB

# Parallel GC threads (adjust based on CPU cores)
-XX:ParallelGCThreads=2
-XX:ConcGCThreads=1

# JVM crash handling
-XX:OnOutOfMemoryError="kill -9 %p"
-XX:+ExitOnOutOfMemoryError

# JVM startup optimizations
-XX:+TieredCompilation
-XX:TieredStopAtLevel=1

# Class verification optimizations
-Xverify:none

# JIT compilation threshold
-XX:CompileThreshold=10000

# Method compilation optimizations
-XX:+UseInlineCaches
-XX:+UseFastAccessorMethods

# Memory allocation optimizations
-XX:+UseFastEmptyMethods
-XX:+UseFastAccessorMethods

# JVM monitoring and profiling
-Dcom.sun.management.jmxremote=false

# Elasticsearch specific optimizations
-Des.enforce.bootstrap.checks=true
-Des.path.home=${ES_PATH_HOME}
-Des.path.conf=${ES_PATH_CONF}
-Des.distribution.flavor=default
-Des.distribution.type=tar
-Des.bundled_jdk=true

# Security manager
-Djava.security.manager=org.elasticsearch.bootstrap.security.ESSecurityManager
-Djava.security.policy=file://${ES_PATH_CONF}/elasticsearch.policy

# Temporary directory
-Djava.io.tmpdir=${ES_TMPDIR}

# DNS cache settings
-Dnetworkaddress.cache.ttl=60
-Dnetworkaddress.cache.negative.ttl=10

# File encoding
-Dfile.encoding=UTF-8

# Locale settings
-Duser.timezone=UTC
-Duser.language=en
-Duser.country=US

# JNA settings
-Djna.nosys=true

# Lucene settings
-Dlucene.experimental.feature.enabled=true

# HTTP client settings
-Dhttp.keepAlive=true
-Dhttp.maxConnections=20

# SSL/TLS settings
-Dhttps.protocols=TLSv1.2,TLSv1.3
-Djdk.tls.ephemeralDHKeySize=2048

# JVM exit handling
-XX:+ExitOnOutOfMemoryError
-XX:OnError="kill -9 %p"

# Performance monitoring
-XX:+PrintGCApplicationConcurrentTime
-XX:+PrintGCApplicationStoppedTime

# Memory leak detection
-XX:+CheckJNICalls

# JIT compiler settings
-XX:+UseCodeCacheFlushing
-XX:ReservedCodeCacheSize=256m
-XX:InitialCodeCacheSize=64m
-XX:CodeCacheExpansionSize=64m

# Class metadata settings
-XX:MetaspaceSize=256m
-XX:MaxMetaspaceSize=512m

# Direct memory settings
-XX:MaxDirectMemorySize=1g

# JVM ergonomics
-XX:+UseAdaptiveSizePolicy
-XX:+UseAdaptiveGCBoundary

# Safepoint settings
-XX:+UnlockDiagnosticVMOptions
-XX:+LogVMOutput
-XX:+TraceClassLoading
-XX:+TraceClassUnloading

# JFR settings for production monitoring
-XX:+FlightRecorder
-XX:FlightRecorderOptions=stackdepth=256

# JVM crash dump settings
-XX:+CreateCoredumpOnCrash
-XX:CoredumpPath=logs/

# JIT compilation logging (disabled by default)
# -XX:+PrintCompilation
# -XX:+UnlockDiagnosticVMOptions
# -XX:+PrintInlining

# Memory debugging (disabled by default)
# -XX:+PrintStringDeduplicationStatistics
# -XX:+PrintGCDetails
# -XX:+PrintGCTimeStamps
# -XX:+PrintGCDateStamps

# Advanced GC tuning (experimental)
# -XX:+UnlockExperimentalVMOptions
# -XX:+UseG1GC
# -XX:MaxGCPauseMillis=200
# -XX:G1HeapRegionSize=32m